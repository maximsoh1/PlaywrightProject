name: Accessibility Tests

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      fail_on_violations:
        description: 'Fail if violations found'
        required: true
        type: boolean
        default: false
      severity_filter:
        description: 'Minimum severity for report'
        required: true
        type: choice
        options:
          - critical
          - serious
          - moderate
          - minor
        default: 'serious'

jobs:
  accessibility-check:
    name: Run Accessibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        dotnet-quality: 'preview'
    
    - name: Restore dependencies
      run: dotnet restore VSProject/VSProject.csproj
    
    - name: Build project
      run: dotnet build VSProject/VSProject.csproj --no-restore --configuration Release
    
    - name: Install Playwright browsers
      run: |
        cd VSProject
        pwsh bin/Release/net10.0/playwright.ps1 install --with-deps chromium
    
    - name: Run Accessibility tests
      id: a11y_tests
      run: |
        dotnet test VSProject/VSProject.csproj \
          --no-build \
          --configuration Release \
          --logger "trx;LogFileName=accessibility-results.trx" \
          --logger "console;verbosity=detailed" \
          --results-directory ./TestResults \
          --filter "Category=accessibility"
      continue-on-error: ${{ !inputs.fail_on_violations }}
      env:
        A11Y_SEVERITY_FILTER: ${{ inputs.severity_filter }}
    
    - name: Parse test results
      if: always()
      id: test_results
      run: |
        if [ -f "TestResults/accessibility-results.trx" ]; then
          TOTAL=$(grep -o 'total="[^"]*"' TestResults/accessibility-results.trx | head -1 | grep -o '[0-9]*')
          PASSED=$(grep -o 'passed="[^"]*"' TestResults/accessibility-results.trx | head -1 | grep -o '[0-9]*')
          FAILED=$(grep -o 'failed="[^"]*"' TestResults/accessibility-results.trx | head -1 | grep -o '[0-9]*')
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
        else
          echo "total=0" >> $GITHUB_OUTPUT
          echo "passed=0" >> $GITHUB_OUTPUT
          echo "failed=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate Accessibility Report Summary
      if: always()
      run: |
        echo "## Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "- Severity Filter: ${{ inputs.severity_filter }}" >> $GITHUB_STEP_SUMMARY
        echo "- Fail on Violations: ${{ inputs.fail_on_violations }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Results:**" >> $GITHUB_STEP_SUMMARY
        echo "- ? Passed: ${{ steps.test_results.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
        echo "- ? Failed: ${{ steps.test_results.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
        echo "- ?? Total: ${{ steps.test_results.outputs.total }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.test_results.outputs.failed }}" != "0" ]; then
          echo "?? **Known Issues:**" >> $GITHUB_STEP_SUMMARY
          echo "The website currently has accessibility violations." >> $GITHUB_STEP_SUMMARY
          echo "These are tracked and will be addressed in future updates." >> $GITHUB_STEP_SUMMARY
        else
          echo "?? **All accessibility tests passed!**" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: accessibility-results
        path: TestResults/accessibility-results.trx
        retention-days: 90
    
    - name: Upload Allure results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-accessibility-results
        path: VSProject/bin/Release/net10.0/allure-results
        retention-days: 90
    
    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: accessibility-screenshots
        path: VSProject/bin/Release/net10.0/screenshots
        retention-days: 30
    
    - name: Fail job if required
      if: inputs.fail_on_violations && steps.a11y_tests.outcome == 'failure'
      run: |
        echo "? Accessibility tests failed and fail_on_violations is true"
        exit 1
